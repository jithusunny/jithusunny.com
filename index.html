<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:24px 16px}
    .wrap{max-width:760px;margin:0 auto}
    h1{margin:0 0 6px}
    h2{margin:28px 0 10px;font-size:18px}
    .sub{opacity:.7;font-size:13px;margin-bottom:14px}
    .card{display:block;padding:12px 14px;margin:8px 0;border:1px solid #e5e7eb;border-radius:14px;background:#f9fafb}
    .meta{font-size:12px;opacity:.7;margin-bottom:4px}
    .txt{font-size:14px;line-height:1.5}
    .row{display:flex;gap:10px;align-items:center;margin-top:10px}
    input,button{font-size:15px;padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px}
    button{background:#f9fafb;cursor:pointer}
    button:hover{background:#f3f4f6}
    a{color:#2563eb;text-decoration:none}
    a:hover{text-decoration:underline}
    .err{color:#b91c1c;border:1px solid #fecaca;background:#fff1f2;border-radius:14px;padding:12px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Thoughts</h1>
  <div class="sub">Quick glance at what’s recent.</div>

  <h2>Latest thoughts</h2>
  <div id="latest"></div>

  <h2>Recent days</h2>
  <div id="days"></div>

  <h2>Pick a day</h2>
  <div class="row">
    <input id="day" type="date" />
    <button id="open">Open day</button>
  </div>
</div>

<script>
const OWNER="jithusunny", REPO="jithusunny.com", BRANCH="main";
const MAX_THOUGHTS=5, MAX_DAYS=5;

const gh=p=>`https://api.github.com/repos/${OWNER}/${REPO}/contents/${p}?ref=${BRANCH}`;
const $=id=>document.getElementById(id);

function previewText(t,max=220){
  t=t.trim().replace(/\s+/g," ");
  if(t.length<=max) return t;
  const cut=t.slice(0,max);
  const p=cut.lastIndexOf(".");
  return (p>80?cut.slice(0,p+1):cut)+" …";
}

function humanDate(d){
  return new Date(d).toLocaleDateString(undefined,{month:"long",day:"numeric",year:"numeric"});
}

function humanTime(day,time){
  const d=new Date(day), now=new Date();
  const diff=Math.floor((now-d)/86400000);
  if(diff===0) return `Today · ${time}`;
  if(diff===1) return `Yesterday · ${time}`;
  return `${humanDate(day)} · ${time}`;
}

async function j(url){const r=await fetch(url);if(!r.ok)throw Error();return r.json()}
async function t(url){const r=await fetch(url);return r.text()}

async function load(){
  try{
    const years=(await j(gh("raw"))).filter(x=>x.type==="dir").map(x=>x.name).sort().reverse();
    const thoughts=[], days=new Set();

    for(const Y of years){
      for(const M of (await j(gh(`raw/${Y}`))).filter(x=>x.type==="dir").map(x=>x.name).sort().reverse()){
        for(const D of (await j(gh(`raw/${Y}/${M}`))).filter(x=>x.type==="dir").map(x=>x.name).sort().reverse()){
          const day=`${Y}-${M}-${D}`;
          days.add(day);
          const files=(await j(gh(`raw/${Y}/${M}/${D}`)))
            .filter(x=>x.name.endsWith(".txt"))
            .sort((a,b)=>b.name.localeCompare(a.name));
          for(const f of files){
            thoughts.push({day,file:f});
            if(thoughts.length>=MAX_THOUGHTS) break;
          }
          if(thoughts.length>=MAX_THOUGHTS) break;
        }
        if(thoughts.length>=MAX_THOUGHTS) break;
      }
      if(thoughts.length>=MAX_THOUGHTS) break;
    }

    for(const x of thoughts){
      const time=x.file.name.replace(".txt","").replace(".",":");
      const text=await t(x.file.download_url);
      const a=document.createElement("a");
      a.className="card";
      a.href=`thought.html?day=${x.day}&file=${x.file.name}`;
      a.innerHTML=`<div class="meta">${humanTime(x.day,time)}</div>
                   <div class="txt">${previewText(text)}</div>`;
      $("latest").appendChild(a);
    }

    [...days].slice(0,MAX_DAYS).forEach(d=>{
      const a=document.createElement("a");
      a.className="card";
      a.href=`day.html?day=${d}`;
      a.innerHTML=`<div class="txt">${humanDate(d)}</div>`;
      $("days").appendChild(a);
    });

    const today=new Date();
    $("day").value=today.toISOString().slice(0,10);
    $("open").onclick=()=>location.href=`day.html?day=${$("day").value}`;

  }catch{
    $("latest").innerHTML=`<div class="err">Could not load thoughts.</div>`;
  }
}
load();
</script>
</body>
</html>
