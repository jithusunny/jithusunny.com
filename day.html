<!-- day.html -->
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body{
        font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        margin:0;
        padding:24px 16px;
      }
      .wrap{max-width:760px; margin:0 auto;}
      a{color:#2563eb; text-decoration:none;}
      a:hover{text-decoration:underline;}
      .top{display:flex; gap:12px; align-items:baseline; margin-bottom:14px;}
      .day{font-size:22px; margin:0;}
      .m{
        background:#f4f4f5;
        border:1px solid #e5e7eb;
        border-radius:16px;
        padding:14px 16px;
        margin:18px 0;
        line-height:1.6;
        font-size:15px;
      }
      .ts{font-size:12px; opacity:.7; display:block; margin-bottom:8px;}
      .txt p{margin:0;}
      .txt p + p{margin-top:10px;}
      .err{color:#b91c1c; white-space:pre-wrap; border:1px solid #fecaca; background:#fff1f2; border-radius:14px; padding:12px 14px; line-height:1.5;}
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="top">
        <a href="index.html">← Back</a>
        <h1 class="day" id="dayTitle"></h1>
      </div>

      <div id="root"></div>
    </div>

    <script>
      function getDayParam() {
        const p = new URLSearchParams(location.search);
        return p.get("day");
      }

      function isValidDay(day) {
        return /^\d{4}-\d{2}-\d{2}$/.test(day);
      }

      function parseBlocks(raw) {
        // Format:
        // 08.50-08.55
        // freeform text...
        //
        // 11.51-11.56
        // freeform text...
        const lines = raw.replace(/\r\n/g, "\n").split("\n");
        const blocks = [];
        let cur = null;

        function pushCur() {
          if (!cur) return;
          const text = cur.text.join("\n").trim();
          if (text.length === 0) return;
          blocks.push({ range: cur.range, text });
        }

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          const m = line.match(/^(\d{2})\.(\d{2})-(\d{2})\.(\d{2})$/);
          if (m) {
            pushCur();
            cur = { range: `${m[1]}:${m[2]}–${m[3]}:${m[4]}`, text: [] };
            continue;
          }
          if (!cur) continue; // ignore any header text before the first range
          cur.text.push(lines[i]); // preserve original spacing
        }

        pushCur();
        return blocks;
      }

      function makeId(day, range) {
        // stable, human-linkable id
        return `${day}_${range.replace(/[:–]/g, "").replace("–","-")}`;
      }

      function toParagraphs(text) {
        // blank lines => new paragraph
        // single newlines => space (readable paragraphs while keeping easy capture)
        const paras = text
          .trim()
          .split(/\n\s*\n/g)
          .map(p => p.replace(/\n+/g, " ").replace(/\s+/g, " ").trim())
          .filter(Boolean);
        return paras;
      }

      function bubble(day, range, text) {
        const id = makeId(day, range);

        const div = document.createElement("div");
        div.className = "m";
        div.id = id;
        div.title = id;

        const ts = document.createElement("span");
        ts.className = "ts";
        ts.textContent = `${day} ${range}`;

        const txt = document.createElement("div");
        txt.className = "txt";

        for (const p of toParagraphs(text)) {
          const el = document.createElement("p");
          el.textContent = p; // safe (no HTML interpretation)
          txt.appendChild(el);
        }

        div.appendChild(ts);
        div.appendChild(txt);
        return div;
      }

      async function run() {
        const day = getDayParam();
        const title = document.getElementById("dayTitle");
        const root = document.getElementById("root");

        if (!day || !isValidDay(day)) {
          const e = document.createElement("div");
          e.className = "err";
          e.textContent = "Missing or invalid day. Use: day.html?day=YYYY-MM-DD";
          root.appendChild(e);
          return;
        }

        title.textContent = day;

        try {
          const url = `data/${day}.txt`;
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) throw new Error(`Could not fetch ${url}`);
          const raw = await res.text();

          const blocks = parseBlocks(raw);
          if (blocks.length === 0) {
            const e = document.createElement("div");
            e.className = "err";
            e.textContent =
`No blocks found.

Expected format inside data/${day}.txt:

08.50-08.55
Your freeform text...

11.51-11.56
More text...`;
            root.appendChild(e);
            return;
          }

          for (const b of blocks) {
            root.appendChild(bubble(day, b.range, b.text));
          }

          if (location.hash) {
            const el = document.getElementById(location.hash.slice(1));
            if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        } catch (err) {
          const e = document.createElement("div");
          e.className = "err";
          e.textContent =
`Could not load the day file.

Make sure:
- data/${day}.txt exists
- you're viewing via GitHub Pages / a web server (not file://)

Error: ${err.message}`;
          root.appendChild(e);
        }
      }

      run();
    </script>
  </body>
</html>
